name: Deploy to Linode

on:
  push:
    branches: [master]
  workflow_dispatch:  # 수동 실행 가능

env:
  DEPLOY_DIR: /home/eias/unhinged-students
  RELEASES_DIR: /home/eias/unhinged-students/releases
  KEEP_RELEASES: 5

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LINODE_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts

      - name: Create new release
        id: release
        run: |
          RELEASE_NAME=$(date +%Y-%m-%d-%H%M%S)
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "Release name: $RELEASE_NAME"

      - name: Deploy to server
        env:
          RELEASE_NAME: ${{ steps.release.outputs.name }}
        run: |
          RELEASE_DIR="${RELEASES_DIR}/${RELEASE_NAME}"
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}"

          echo "=== 1. 새 릴리즈 디렉토리 생성 ==="
          $SSH_CMD "mkdir -p $RELEASE_DIR"

          echo "=== 2. 파일 동기화 ==="
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.claude' \
            --exclude 'docs' \
            --exclude '*.md' \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:${RELEASE_DIR}/

      - name: Install dependencies and switch release
        env:
          RELEASE_NAME: ${{ steps.release.outputs.name }}
        run: |
          RELEASE_DIR="${RELEASES_DIR}/${RELEASE_NAME}"
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}"

          echo "=== 3. npm install ==="
          $SSH_CMD "cd ${RELEASE_DIR} && npm install --production"

          echo "=== 4. 심볼릭 링크 전환 ==="
          $SSH_CMD "ln -sfn ${RELEASE_DIR} ${DEPLOY_DIR}/current"

          echo "=== 5. 서비스 재시작 ==="
          $SSH_CMD "sudo systemctl restart unhinged-students.service"

          sleep 2

          echo "=== 6. 서비스 상태 확인 ==="
          $SSH_CMD "sudo systemctl status unhinged-students.service --no-pager" || true

      - name: Cleanup old releases
        run: |
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}"

          echo "=== 오래된 릴리즈 정리 (최근 ${KEEP_RELEASES}개 유지) ==="
          $SSH_CMD "
            cd ${RELEASES_DIR}
            for release in \$(ls -t | tail -n +\$((${KEEP_RELEASES} + 1))); do
              echo \"Removing: \$release\"
              rm -rf \"\$release\"
            done
            echo 'Remaining releases:'
            ls -t
          "
