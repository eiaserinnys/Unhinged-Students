name: Deploy to Linode

on:
  push:
    branches: [master]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  DEPLOY_DIR: /home/eias/services/unhinged-students
  RELEASES_DIR: /home/eias/services/unhinged-students/releases
  KEEP_RELEASES: 5

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¢ Discord ì•Œë¦¼ (ë°°í¬ ì‹œì‘)
        run: |
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"ğŸš€ ë°°í¬ ì‹œì‘\", \"description\": \"**unhinged-students** ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\", \"color\": 3447003, \"fields\": [{\"name\": \"ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true}, {\"name\": \"ì»¤ë°‹\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true}, {\"name\": \"ì‹¤í–‰ì\", \"value\": \"${{ github.actor }}\", \"inline\": true}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LINODE_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts

      - name: Create new release
        id: release
        run: |
          RELEASE_NAME=$(date +%Y-%m-%d-%H%M%S)
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "Release name: $RELEASE_NAME"

      - name: Deploy to server
        env:
          RELEASE_NAME: ${{ steps.release.outputs.name }}
        run: |
          RELEASE_DIR="${RELEASES_DIR}/${RELEASE_NAME}"
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}"

          echo "=== 1. ìƒˆ ë¦´ë¦¬ì¦ˆ ë””ë ‰í† ë¦¬ ìƒì„± ==="
          $SSH_CMD "mkdir -p $RELEASE_DIR"

          echo "=== 2. íŒŒì¼ ë™ê¸°í™” ==="
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.claude' \
            --exclude 'docs' \
            --exclude '*.md' \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:${RELEASE_DIR}/

      - name: Install dependencies and switch release
        env:
          RELEASE_NAME: ${{ steps.release.outputs.name }}
        run: |
          RELEASE_DIR="${RELEASES_DIR}/${RELEASE_NAME}"
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}"

          echo "=== 3. npm install ==="
          $SSH_CMD "cd ${RELEASE_DIR} && npm install --production"

          echo "=== 4. ì‹¬ë³¼ë¦­ ë§í¬ ì „í™˜ ==="
          $SSH_CMD "ln -sfn ${RELEASE_DIR} ${DEPLOY_DIR}/current"

          echo "=== 5. ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ==="
          $SSH_CMD "sudo systemctl restart unhinged-students.service"

          sleep 2

          echo "=== 6. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ==="
          $SSH_CMD "sudo systemctl status unhinged-students.service --no-pager" || true

      - name: Cleanup old releases
        run: |
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}"

          echo "=== ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ (ìµœê·¼ ${KEEP_RELEASES}ê°œ ìœ ì§€) ==="
          $SSH_CMD "
            cd ${RELEASES_DIR}
            for release in \$(ls -t | tail -n +\$((${KEEP_RELEASES} + 1))); do
              echo \"Removing: \$release\"
              rm -rf \"\$release\"
            done
            echo 'Remaining releases:'
            ls -t
          "

      - name: ğŸ“¢ Discord ì•Œë¦¼ (ë°°í¬ ì„±ê³µ)
        if: success()
        run: |
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"âœ… ë°°í¬ ì™„ë£Œ\", \"description\": \"**unhinged-students** ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\", \"color\": 5763719, \"fields\": [{\"name\": \"ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true}, {\"name\": \"ì»¤ë°‹\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: ğŸ“¢ Discord ì•Œë¦¼ (ë°°í¬ ì‹¤íŒ¨)
        if: failure()
        run: |
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"âŒ ë°°í¬ ì‹¤íŒ¨\", \"description\": \"**unhinged-students** ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\", \"color\": 15548997, \"fields\": [{\"name\": \"ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true}, {\"name\": \"ì»¤ë°‹\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true}, {\"name\": \"ì›Œí¬í”Œë¡œìš°\", \"value\": \"[ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true
